/* Кир - добавлен счет 40702810300000000265 - бесплатное р/к обслуживание 28.02.2000*/
/*Edit Drujaev
 Расчет за проведение платежных документов за текущий день
        */

FILE docum(document) sort 0;
/*FILE docum(arhdoc) sort 0;*/
FILE acc(account) sort 0;
file pos(postdoc) sort 2 write;
file spz("obsl_por.txt") txt 1024 write;
file kl(client) sort 0;
/*sum_mes1=money(500);*/
polu=" ";
NumberP=684;
/*n_sch="70107810500001720320";    M*/
n_sch="70107810201001720302";
acc.account=n_sch;

 Macro InNull(Bik,Acc,Cor,AccP) 	/* Исключением платежей в Бюджет */

   BalNoRKC=",40101,40102,40105,40106,40107,40108,40110,40112,40113,40114,40201,40202,"
      +"40203,40204,40206,40301,40302,40303,40304,40306,40309,40312,40314,"   
      +"40401,40102,40403,40404,40405,40406,40407,40408,40409,40410,";

   CorNoRKC=",30101,30103,30105,";

   BalNoBank=",40101,40102,40105,40106,40107,40108,40110,40201,40202,"
      +"40203,40204,40206,40301,40302,40303,40304,40306,40309,"
      +"40401,40102,40403,40404,40405,40406,40407,40408,40409,40410,";

   BalNoAcc=",40405810000000000002,40102810200000990006,40101810900000010001"
           +",40101810300000020002,40407810100001020002,40407810300001010003"
	   +",40407810800001030004,40408810000000000038,40408810400000000036"
	   +",40408810300000000042,40401810900001010001,40403810700001000002"
	   +",40404810300001000003,40204810500000100001,40402810500000000008"
           +",40602810501000000009,40603810501002000006" /*Горбольница 1 и Цертус*/
           +",40602810501000000009,40602810101000000027,"+
             "40702810101000000150,40702810801000000159,"+
             "40702810901000000169,40702810001000000001,40602810101000000043,"+
	     "40802810601000000068,40802810301000000070,"+
             "40802810101000000047,40702810901000000266,40702810601000000294,"+
             "40702810501000000242,40702810301000000293,40702810401000000274,"+
             "40702810401000000326,40702810401000000106,40702810901000000240,"+
             "40702810901000000363,40802810301000000245,"+
             "40702810401000000054,40702810401000000410,"+
             "40802810901000000195,40702810101000000299,"+
             "40802810701000000023,40802810001000000176,40702810001000000140,"+
             "40802810301000000232,40702810901000000444,"+
             "40702810501000000268,40702810101000000309,40702810101000000370,"+
             "40702810401000000371,40702810601000000414,40802810701000000104,"+
 	     "40702810401000000436,40802810001000000150,"+
 	     "40702810101000000419,40702810501000000297,"+
 	     "40702810201000000144,40802810401000000006,"+
 	     "40703810001000000042,40802810401000000530,"+
 	     "40702810001000000344,40702810301000000439,"+
 	     "40802810901000000373,40702810601000000087,"+
 	     "40702810201000000542,40702810201000000092,40702810101000000325,"+
 	     "40702810801000000515,40802810401000000404,40702810301000000594,"+
 	     "40702810401000000478,40802810401000000446,"+
 	     "40702810801000000609,40702810601000000621,40702810801000000573,"+
 	     "40802810101000000377,40802810501000000139,40702810601000000281,"+
 	     "40702810401000000229,40802810401000000129,"+
 	     "40702810001000000603,40802810501000000333,40702810001000000551,"+
 	     "40802810301000000371,40702810101000000587,40702810701000000644,"+
 	     "40802810401000000310,40802810101000000283,40702810001000000564,"+
 	     "40802810401000000019,40802810601000000262,40702810301000000413,"+
             "40802810901000000506,40802810401000000501,40702810101000000561,"+
             "40802810901000000548,40702810001000000632,40702810201000000270,"+
             "40702810301000000413,40702810601000000100,40802810601000000246,"+
             "40702810701000000686,40702810801000000667,40802810901000000580,"+
             "40702810401000000119,40702810001000000687,40702810301000000617,"+
             "40802810401000000093,40702810101000000529,40702810701000000712,"+
             "40702810001000000713,40802810501000000320,40802810101000000348,"+
             "40802810401000000624,40702810601000000728,40702810101000000707,"+
             "40802810901000000632,40802810301000000601,";
  BikI=SubStr(Bic,7,3);
  CorI=","+SubStr(Cor,1,5)+",";
  AccI=","+AccP+",";
/*  if (Bik=="044583001")    Return 1;  end;        M*/
/*  if (Bik=="04635900")    Return 1;  end;        */
  if (Index(BalNoAcc,AccI)!=0)    Return 2;  end;
  if (Index(BalNoBank,SubStr(acc,1,5))!=0)    Return 3;  end;

  Return 0; /*Можно взыскать по тарифу*/
 End;

if (geteq(acc))
  kl.client=acc.client;
  if (geteq(kl))
    polu=kl.name_client;
  end;
end;


/*******************Точка входа**********/
op={oper};
/*GetInt(op,"Введите номер операциониста");*/

rewind(pos);
clearrecord(pos);
  while( next(pos))
  if ((pos.Number_Pack==NumberP) ) Delete(pos); end;
  end;
rewind(docum);
clearrecord(docum);
nom=0;
i=0;
NR=NRecords(docum); 
   InitProgress( NR, " Выпуск отчета", "Обработано строк отчета" );
  while( next(docum))
  i=i+1;
  UseProgress(i);
/*  if (docum.Account_Payer=="40702810800000000215") MsgBox (docum.real_payer); end;  */
    if (
        (int(substr(docum.real_payer,6,3))==810) /* Без покрытия*/
    and (docum.MFO_Receiver!="")                 /*Все внешние*/
    and (int(substr(docum.real_payer,1,3))>401)  /* Только счета клиентов*/
    and (int(substr(docum.real_payer,1,5))<40817)  /* Только счета клиентов*/
    and (InNull(docum.MFO_Receiver,docum.Account_Receiver,docum.CorAcc_Receiver,docum.Account_Payer)==0)	/* За исключением платежей в Бюджет */
    and (docum.Result_Carry!=23)

 /*   and (docum.Oper==op)             Только по нужному операцианисту */
     )

      clearrecord(acc);

/*Edit Polyakov 24.11.2005*/    
      s_obl=money(0);
      if ((docum.Result_Carry==111) or (docum.Result_Carry==113)) 
      	 s_obl=Money(500);
      elif (docum.Result_Carry==112)
         s_obl=Money(500);
      else 
         s_obl=Money(1000); 
      end;
/*Edit Polyakov 24.11.2005*/      
      acc.account=docum.real_payer;
      if (geteq(acc))
        if (s_obl!=money(0))
          pos.real_payer=docum.real_payer;
          pos.date_document={curdate};
          pos.sum=money(0);
          if (getge(pos) and (pos.real_payer==docum.real_payer)
             and (pos.Number_Pack==NumberP) )
            if (pos.Number_Pack==NumberP) 
            pos.sum=pos.sum+s_obl;
            update(pos);
            end;
          else
            clearrecord(pos);
            copy(pos,docum);   
            pos.Shifr_Oper="09";
            pos.date_document={curdate};
            pos.date_value={curdate};
            pos.MFO_Receiver="";
            pos.CorAcc_receiver="";
            pos.Bank_receiver="АКБ София";
	    pos.Receiver="Плата за обработку расчетных документов";
            pos.account_receiver=n_sch;
            pos.real_receiver=n_sch;
            pos.Dispatch=0; 
            pos.sum=s_obl;
	    pos.post_sun=0;
            pos.ground="За проведение платежных док-тов за "+string({curdate})+"/"+pos.account_payer+".Без НДС.";
            pos.Number_Pack=NumberP;
            pos.iApplicationKind=0;
            pos.ApplicationKey="";
            pos.Kind_Carry=0;
	    pos.Result_Carry=0;
            insert(pos);
          end;
        end;
      end;
    end;
  end;
RemProgress;
println("   Расчет за проведение платежных поручений и требований ");
println("            За дату  ",{curdate});
/*println(" ----------------------------------------------------------");
println("   N      Счет плательщика     Счет получателя      Сумма  ");
println(" ----------------------------------------------------------");*/
rewind(pos);
sum_o=money(0);
i=0;
while( next(pos));
 if (pos.Number_Pack==NumberP)
  i=i+1;
  message(i);
  nom=i;
/*  pos.oper=i;*/
  pos.numb_document=string(nom);
  plat=pos.payer;
  n_summa=string(pos.sum*100);
  strok=pos.numb_document+", 6,,"+pos.real_payer+",,"+n_sch+","+n_summa+",995,30,0"+",  0,  0,"+plat+","+polu+","+pos.ground;
  spz.str=strok;
  insert(spz);
/*  if(pos.Oper==op)*/
   sum_o=sum_o+pos.sum;
   println(" ",pos.oper:a:5," ",pos.real_payer,"  ",pos.real_receiver,"  ",pos.sum:a:10," ")
/*  end;                */
 end;
end;
if (i==0)
  spz.str=" ";
  insert(spz);
end;

println("            --Итого по расчету --");
println("                                         ",sum_o:a:20);
/* */
end;
 





 
 